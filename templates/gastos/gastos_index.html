{% extends "base.html" %}

{% block content %}

<section class="mb-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-1">Gastos</h1>
      <p class="small mb-0">
        Registra compras, impuestos, envíos y otros. Visualiza totales mensuales y por categoría.
      </p>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('gastos_nuevo') }}" class="btn btn-accent btn-sm">
        + Nuevo gasto
      </a>
    </div>
  </div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {% for msg in messages %}<div>{{ msg }}</div>{% endfor %}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endif %}
  {% endwith %}

  <!-- Filtros -->
  <div class="card card-panel mb-3">
    <div class="card-body">
      <form class="row g-2" method="get" action="{{ url_for('gastos_index') }}">
        <div class="col-6 col-md-3">
          <label class="form-label small">Mes</label>
          <select name="month" class="form-select">
            {% for num, nombre in meses %}
              <option value="{{ num }}" {% if num == mes_actual %}selected{% endif %}>{{ nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label small">Año</label>
          <select name="year" class="form-select">
            {% for a in años %}
              <option value="{{ a }}" {% if a == año_actual %}selected{% endif %}>{{ a }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label small">Categoría</label>
          <select name="cat" class="form-select">
            <option value="">Todas</option>
            {% for c in categorias %}
              <option value="{{ c }}" {% if c == cat_sel %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-6 col-md-3 d-flex align-items-end">
          <button class="btn btn-outline-light w-100">Filtrar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Resumen tarjetas -->
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card card-panel h-100">
        <div class="card-body">
          <p class="small mb-1">Total del mes</p>
          <p class="h4 mb-0">${{ total_mes|clp }}</p>
          <p class="small text-muted mb-0">
            {{ inicio_mes.strftime("%m-%Y") }}
          </p>
        </div>
      </div>
    </div>

    <!-- Totales por categoría -->
    {% for cat, monto in por_categoria.items() %}
      <div class="col-md-4">
        <div class="card card-panel h-100">
          <div class="card-body">
            <p class="small mb-1">{{ cat }}</p>
            <p class="h5 mb-0">${{ monto|clp }}</p>
            <p class="small text-muted mb-0">del mes seleccionado</p>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Listado -->
  <div class="card card-panel mt-3">
    <div class="card-body">
        <h2 class="h6 mb-3">Gastos del mes</h2>

        <div class="table-responsive">
            <table class="table table-sm table-dark align-middle mb-0">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Categoría</th>
                        <th>Detalle</th>
                        <th class="text-end">Monto</th>
                        <th class="text-end">Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for g in gastos %}
                        <tr>
                            <td>{{ g.fecha.strftime("%d-%m-%Y") }}</td>
                            <td>{{ g.categoria }}</td>
                            <td>{{ g.detalle }}</td>
                            <td class="text-end">
                                ${{ g.monto|clp }}
                            </td>
                            <td class="text-end">
                                <a href="{{ url_for('gastos_editar', gasto_id=g.id) }}"
                                   class="btn btn-sm btn-outline-info me-1">
                                   Editar
                                </a>

                                <form action="{{ url_for('gastos_eliminar', gasto_id=g.id) }}"
                                      method="POST"
                                      style="display:inline;"
                                      onsubmit="return confirm('¿Eliminar este gasto?');">
                                    <button class="btn btn-sm btn-outline-danger">
                                        Eliminar
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center small">
                                No hay gastos registrados este mes.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
</section>

{% endblock %}